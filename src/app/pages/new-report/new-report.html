<div class="min-h-screen relative overflow-hidden bg-gray-50">

  <div class="relative z-20">
    <app-header-client></app-header-client>
  </div>

  <div class="relative z-10 container mx-auto px-4 py-14   grid grid-cols-1 lg:grid-cols-3 gap-6 md:px-16">

    <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-lg">

      <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-md p-4 mb-6">
        <h2 class="text-xl font-bold flex items-center gap-2 mb-2">
          <svg class="w-6 h-6" viewBox="0 0 128 128">
            <use xlink:href="assets/sprite.svg#firecolor"></use>
          </svg>
           Reporte de emergencia de incendio
        </h2>
        <p class="text-sm">Informar el incidente para una respuesta de emergencia inmediata</p>
      </div>

      <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" class="space-y-6 pt-3">

        <div *ngIf="showSuccess" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
          <span class="block sm:inline">¡Reporte enviado exitosamente! Las autoridades han sido notificadas.</span>
          <span class="absolute top-0 bottom-0 right-0 px-4 py-3" (click)="closeSuccess()">
            <svg class="fill-current h-6 w-6 text-green-500 cursor-pointer" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <title>Cerrar</title>
              <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
            </svg>
          </span>
        </div>

        <div *ngIf="showError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <span class="block sm:inline">{{errorMessage}}</span>
          <span class="absolute top-0 bottom-0 right-0 px-4 py-3" (click)="closeError()">
            <svg class="fill-current h-6 w-6 text-red-500 cursor-pointer" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <title>Cerrar</title>
              <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
            </svg>
          </span>
        </div>

        <!-- Tipo de vegetación y fuente de incendio -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de vegetación afectada *</label>
            <select formControlName="tipoVegetacion"
              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              [class.border-red-500]="isFieldInvalid('tipoVegetacion')">
              <option value="">Selecciona el tipo de vegetación</option>
              <option value="PASTIZAL">Pastizal</option>
              <option value="BOSQUE">Bosque</option>
              <option value="CULTIVO">Cultivo</option>
              <option value="URBANO">Zona urbana</option>
              <option value="MIXTO">Mixto</option>
            </select>
            <div *ngIf="isFieldInvalid('tipoVegetacion')" class="text-red-500 text-xs mt-1">
              {{getFieldError('tipoVegetacion')}}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Posible fuente de incendio *</label>
            <select formControlName="fuenteIncendio"
              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
              [class.border-red-500]="isFieldInvalid('fuenteIncendio')">
              <option value="">Selecciona la fuente posible</option>
              <option value="NATURAL">Natural (rayo, sequía)</option>
              <option value="HUMANO">Negligencia humana</option>
              <option value="DESCONOCIDO">Desconocido</option>
            </select>
            <div *ngIf="isFieldInvalid('fuenteIncendio')" class="text-red-500 text-xs mt-1">
              {{getFieldError('fuenteIncendio')}}
            </div>
          </div>
        </div>

        <!-- Área estimada afectada -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Área estimada afectada (hectáreas) *</label>
          <input type="number" formControlName="areaAfectada" step="0.1" min="0.1" placeholder="Ej. 2.5"
            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
            [class.border-red-500]="isFieldInvalid('areaAfectada')" />
          <div *ngIf="isFieldInvalid('areaAfectada')" class="text-red-500 text-xs mt-1">
            {{getFieldError('areaAfectada')}}
          </div>
          <p class="text-xs text-gray-500 mt-1">Ingresa el área en hectáreas (1 hectárea = 10,000 m²)</p>
        </div>

        <!-- Descripción -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Descripción del incidente *</label>
          <textarea rows="4" formControlName="descripcion"
            placeholder="Describe el incidente: intensidad del fuego, estructuras afectadas, personas en riesgo, viento, visibilidad, etc."
            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
            [class.border-red-500]="isFieldInvalid('descripcion')"></textarea>
          <div *ngIf="isFieldInvalid('descripcion')" class="text-red-500 text-xs mt-1">
            {{getFieldError('descripcion')}}
          </div>
        </div>

      <!-- Fotos y vídeos -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Fotos o vídeos (opcional)</label>

          <!-- Área de carga -->
          <div (click)="fileInput.click()" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
            [class.border-blue-500]="isDragOver" [class.bg-blue-50]="isDragOver"
            class="border-2 border-dashed border-gray-300 rounded-md py-10 flex flex-col items-center justify-center text-center text-sm text-gray-500 cursor-pointer hover:border-gray-400 transition-colors">
            <div class="text-2xl">⬆️</div>
            <p class="mt-2">Haga clic o arrastre para cargar fotos y vídeos</p>
            <p class="text-xs text-gray-400">Soporta: JPG, PNG, GIF, MP4, WebM (máx. 10MB c/u, máx. 5 archivos)</p>
          </div>

          <input #fileInput type="file" multiple accept="image/*,video/*" (change)="onFileSelected($event)" class="hidden" />

          <!-- Vista previa de archivos -->
          <div *ngIf="selectedFiles.length > 0" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-2">
            <div *ngFor="let file of selectedFiles; let i = index" class="relative border rounded-lg overflow-hidden">
              <!-- Preview for images -->
              <div *ngIf="isImageFile(file)" class="relative">
                <img [src]="getFilePreview(i)" [alt]="file.name" class="w-full h-24 object-cover">
                <button (click)="removeFile(i)" type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                  ×
                </button>
              </div>

              <!-- Preview for videos -->
              <div *ngIf="isVideoFile(file)" class="relative bg-gray-100 h-24 flex items-center justify-center">
                <div class="text-center">
                  <div class="text-2xl">🎥</div>
                  <div class="text-xs text-gray-600 truncate px-1">{{file.name}}</div>
                </div>
                <button (click)="removeFile(i)" type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                  ×
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Botón principal -->
        <div>
          <button type="submit" [disabled]="isSubmitting || reportForm.invalid"
            class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold py-3 rounded hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <div *ngIf="isSubmitting" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
            <span *ngIf="!isSubmitting">Enviar reporte de emergencia</span>
            <span *ngIf="isSubmitting && selectedFiles.length > 0">Subiendo archivos...</span>
            <span *ngIf="isSubmitting && selectedFiles.length === 0">Enviando reporte...</span>
          </button>

          <!-- Información adicional sobre archivos grandes -->
          <div *ngIf="selectedFiles.length > 0" class="mt-2">
            <p class="text-xs text-gray-600 text-center">
              Los archivos grandes pueden tomar algunos minutos en subir
            </p>
          </div>
        </div>
      </form>
    </div>

    <div class="bg-white rounded-xl p-6 shadow-lg flex flex-col gap-6">
      <div>
        <h3 class="text-xl font-bold flex items-center gap-2"><svg class="w-6 h-6" viewBox="0 0 24 24"><use xlink:href="/assets/sprite.svg#gps" /></svg> Ubicación GPS</h3>
        <!-- Estado de carga de ubicación -->
        <div *ngIf="isGettingLocation" class="text-sm text-blue-600 flex items-center gap-2 mt-2">
          <div class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
          Obteniendo ubicación...
        </div>

        <!-- Error de ubicación -->
        <div *ngIf="locationError && !isGettingLocation" class="text-sm text-red-600 mt-2">
          <p>{{locationError}}</p>
          <button (click)="retryLocation()" class="text-blue-600 underline hover:no-underline text-xs mt-1">
            Intentar de nuevo
          </button>
        </div>

        <!-- Estados normales -->
        <p class="text-sm text-gray-500" *ngIf="selectedLocation.isAutomatic && !isGettingLocation && !locationError">
          Ubicación GPS automática
        </p>
        <p class="text-sm text-gray-500" *ngIf="!selectedLocation.isAutomatic && !isGettingLocation">
          Ubicación seleccionada manualmente
        </p>

        <!-- Información de ubicación -->
        <p class="text-green-600 font-medium mt-2"
          *ngIf="selectedLocation.isAutomatic && !isGettingLocation && !locationError && !selectedLocation.cityName">
          Ubicación GPS adquirida: Lat: {{selectedLocation.latitude}} – Long: {{selectedLocation.longitude}}
        </p>

        <div class="text-green-600 font-medium mt-2" *ngIf="selectedLocation.cityName && !isGettingLocation">
          <p class="font-semibold"> <svg class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24"><use xlink:href="/assets/sprite.svg#ubication" /></svg> {{selectedLocation.cityName}}</p>
          <p class="text-sm">{{selectedLocation.country}}
            <span *ngIf="selectedLocation.region"> • {{selectedLocation.region}}</span>
            <span *ngIf="selectedLocation.population > 0"> • {{selectedLocation.population | number}} hab.</span>
          </p>
          <p class="text-xs text-gray-600">Lat: {{selectedLocation.latitude}} – Long: {{selectedLocation.longitude}}</p>
        </div>

        <p class="text-green-600 font-medium mt-2" *ngIf="!selectedLocation.isAutomatic && !selectedLocation.cityName && !isGettingLocation">
          Ubicación manual: Lat: {{selectedLocation.latitude}} – Long: {{selectedLocation.longitude}}
        </p>
      </div>
      <button (click)="openModal()"
        class="w-full border border-blue-500 text-blue-600 font-medium rounded py-2 hover:bg-blue-50 transition flex items-center justify-center gap-2">
          <svg width="24" height="24" viewBox="0 0 24 24">
          <use xlink:href="/assets/sprite.svg#search" />
        </svg>
        Buscar ciudad
      </button>
      <button (click)="retryLocation()"
        class="w-full border border-green-500 text-green-600 font-medium rounded py-2 hover:bg-green-50 transition flex items-center justify-center gap-2">
      <svg class="size-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <use xlink:href="/assets/sprite.svg#reload" />
        </svg>
        Obtener mi ubicación GPS
      </button>

      <!-- Mapa dinámico que se actualiza con la ubicación -->
      <div class="w-full h-64 rounded border overflow-hidden">
        <iframe [src]="getMapUrl()" class="w-full h-full border-0" allowfullscreen loading="lazy">
        </iframe>
      </div>
    </div>
  </div>

  <!-- Modal de búsqueda de ciudades -->
  <div *ngIf="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center" (keydown)="onKeydown($event)">
    <div class="fixed inset-0 bg-black/50 bg-opacity-50 modal-overlay" (click)="closeModal()"></div>

    <div class="relative bg-white rounded-md border shadow-md w-80 p-0 z-50 max-h-96 flex flex-col modal-content">
      <div class="flex items-center border-b px-3">
        <svg width="24" height="24" viewBox="0 0 24 24"
          class="mr-2 h-4 w-4 shrink-0 opacity-50">
          <use xlink:href="/assets/sprite.svg#search" />
        </svg>
        <input [(ngModel)]="searchTerm" (input)="onSearchInput()" (keydown)="onKeydown($event)"
          class="flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-gray-400 disabled:cursor-not-allowed disabled:opacity-50"
          placeholder="Buscar ciudades..." type="text" autocomplete="off" #searchInput>
      </div>

      <div class="max-h-72 overflow-y-auto overflow-x-hidden">
        <div class="overflow-hidden p-1 text-gray-900">

          <!-- Resultados de búsqueda -->
          <ng-container *ngIf="searchTerm.length >= 2">
            <div class="px-2 py-1.5 text-xs font-medium text-gray-600" *ngIf="cities.length > 0 || isLoading">
              Resultados de búsqueda
            </div>

            <div *ngIf="isLoading" class="px-3 py-2 text-sm text-gray-500">
              <div class="flex items-center gap-2">
                <div class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                Buscando...
              </div>
            </div>

            <div *ngIf="!isLoading && cities.length === 0"
              class="px-3 py-2 text-sm text-gray-500">
              No se encontraron ciudades
            </div>

            <div *ngFor="let city of cities" (click)="selectCity(city)"
              class="px-3 py-2 text-sm cursor-pointer hover:bg-gray-100 rounded-md mx-1 city-item">
              <div class="font-medium">{{city.name}}</div>
              <div class="text-xs text-gray-500">
                {{city.country}}
                <span *ngIf="city.region"> • {{city.region}}</span>
                <span *ngIf="city.population"> • {{city.population | number}} hab.</span>
              </div>
              <div class="text-xs text-gray-400">Lat: {{city.latitude}}, Long: {{city.longitude}}</div>
            </div>
          </ng-container>

          <!-- Ciudades cercanas cuando no hay búsqueda -->
          <ng-container *ngIf="searchTerm.length < 2">
            <div class="px-2 py-1.5 text-xs font-medium text-gray-600" *ngIf="nearbyCities.length > 0 || isLoadingNearby">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Ciudades cercanas a tu ubicación
              </div>
            </div>

            <div *ngIf="isLoadingNearby" class="px-3 py-2 text-sm text-gray-500">
              <div class="flex items-center gap-2">
                <div class="animate-spin h-4 w-4 border-2 border-green-500 border-t-transparent rounded-full"></div>
                Buscando ciudades cercanas...
              </div>
            </div>

            <div *ngIf="!isLoadingNearby && nearbyCities.length === 0 && selectedLocation.latitude"
              class="px-3 py-2 text-sm text-gray-500">
              <div class="text-center">
                <svg class="w-8 h-8 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                No se encontraron ciudades cercanas
              </div>
            </div>

            <div *ngFor="let city of nearbyCities" (click)="selectCity(city)"
              class="px-3 py-2 text-sm cursor-pointer hover:bg-green-50 hover:border-green-200 rounded-md mx-1 city-item border border-transparent transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <div class="flex-1">
                  <div class="font-medium">{{city.name}}</div>
                  <div class="text-xs text-gray-500">
                    {{city.country}}
                    <span *ngIf="city.region"> • {{city.region}}</span>
                    <span *ngIf="city.population"> • {{city.population | number}} hab.</span>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="!isLoadingNearby && !selectedLocation.latitude" class="px-3 py-2 text-sm text-gray-500 text-center">
              <div class="py-4">
                <svg class="w-8 h-8 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <p class="text-sm">Permitir ubicación para ver ciudades cercanas</p>
                <p class="text-xs mt-1">O escribe al menos 2 caracteres para buscar</p>
              </div>
            </div>
          </ng-container>

        </div>
      </div>
    </div>
  </div>
</div>
